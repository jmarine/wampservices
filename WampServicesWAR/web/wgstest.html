<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>WebSocket game services client</title>
                <link rel="stylesheet" href="css2/jquery-ui.css" />
		<script type="text/javascript" src="js/jquery-1.8.3.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.9.2.js"></script>
		<script type="text/javascript" src="js/wgsclient.js"></script>
<style type="text/css">

* {
  font-family: Verdana, sans-serif;
  font-size: 12px;
  color: #6c3000;
}

body {
  background: #f7e3a4; 
}

button, input, select, option {
  background: #fff0c0; 
}

.scrollTableData {
  background: #fff0c0; 
  border: 1px #6c3000 solid;
}

.scrollTableHeader {
  background: #dac394;
  border: 1px #6c3000 solid; border-top-left-radius: 6px; border-top-right-radius: 6px;
}

.scrollTableRow > td {
  border-bottom: 1px #6c3000 solid; 
}

button, input, select {
  border: 1px #6c3000 solid;
  margin-bottom: 2px;
  /* margin-top: 1px; */  
}


button {
  border-radius: 6px;
  margin-top: 5px;
}

.ui-buttonset { 
  alignment-baseline: central;
}

.ui-corner-all { border-radius: 4px; }
.ui-menu { list-style:none; padding: 2px; margin: 0; display:block; outline: none; }
.ui-menu .ui-menu-item { margin: 0; padding: 0; zoom: 1; width: 100%; background-color: #fff0c0; }
.ui-menu .ui-menu-item a { text-decoration: none; display: block; padding: 2px 1px; line-height: 1.5; zoom: 1;  }
.ui-menu .ui-menu-item a.ui-state-focus,
.ui-menu .ui-menu-item a.ui-state-active { background:#dac394; }


#openid_providers_menu {
    border: 1px #6c3000 solid;
    border-radius: 6px; 
    margin-top: 2px;
}

#toggle_connect {
    border-top-right-radius: 0px;
    border-bottom-right-radius: 0px;
}

#oic_connect {
    border-top-left-radius: 0px;
    border-bottom-left-radius: 0px;
    margin-left: -5px;
    padding-left: 0px;
    padding-right: 0px;
    background-image: url(images/oic.png) ;
    background-repeat: no-repeat;
    background-position: left center;
    background-size: 14px,14px;
    width: 20px;
}

button:active {
  background: #dac394;
}

button:disabled, input:disabled {
  background: #f7e3a4;
  color: #777777;
}

option:active {
  background-color: #dac394;
}

fieldset { border: 1px #6c3000 solid; border-radius: 10px; }
legend { border: 1px #6c3000 solid; margin-left: 0.5em; padding: 0.2em 0.8em; border-radius: 10px; font-weight: bold; color: #6c3000; background:#dac394 }

label { /*display: block;*/ float: left; width: 90px; clear: left; }

.section { clear: both; width: 100%; padding-bottom: 10px; padding-right: 20px; }
.right { float: left; clear: right; }

.hidden { display: none; }

</style>

<script language="javascript">
var wgsclient = null;
var currentApp = null;
var currentGroup = null;

$(document).ready(function(){
    $('#apps').click(function() {
        var c =  $("#apps > option:selected").size();
        $('#btn_automatch_group').each(function() {
          this.disabled = (c==0);
        });
        $('#btn_select_app').each(function() {
          this.disabled = (c==0);
        });
        $('#btn_delete_app').each(function() {
          this.disabled = (c==0);
        });
    });
    
    $('#groups').click(function() {
        var groups = $("#groups > option:selected");
        var c =  groups.size();
        $('#btn_play_group').each(function() {
          this.disabled = (c==0);
        });
        $('#btn_view_group').each(function() {
          this.disabled = (c==0) || (groups[0].attributes['observable'].value != "true");
        });

    });
    
});

function adjustScrollTable(tableName){
 
  var colCount = $('#' + tableName + 'Header .columnHeader').length; //get total number of column
 
  var m = 0;
  var n = 0;
  var brow = 'mozilla';
 
  jQuery.each(jQuery.browser, function(i, val) {
    if(val == true){
      brow = i.toString();
    }
  });
 
 
  if($('#' + tableName + 'Table tr').size() <= 0) {
    $('#' + tableName + 'Header table').width("100%");
  } else {
    $('#' + tableName + 'Header table').width("0");
    $('#' + tableName + 'Header .columnHeader').each(function(i){
      if (m < colCount){

        if (brow == 'mozilla'){
          $('#firstTd').css("width",$('.tableFirstCol').innerWidth());//for adjusting first td
          $(this).css('width',$('#' + tableName + 'Table td:eq('+m+')').innerWidth());//for assigning width to table Header div
        }
        else if (brow == 'msie'){
          $('#firstTd').css("width",$('.tableFirstCol').width());
          $(this).css('width',$('#' + tableName + 'Table td:eq('+m+')').width()-2);//In IE there is difference of 2 px
        }
        else if (brow == 'safari'){
          $('#firstTd').css("width",$('.tableFirstCol').width());
          $(this).css('width',$('#' + tableName + 'Table td:eq('+m+')').width());
        }
        else {
          $('#firstTd').css("width",$('.tableFirstCol').width());
          $(this).css('width',$('#' + tableName + 'Table td:eq('+m+')').innerWidth());
        }
      }
      m++;
    });
  }
   
/*  
  $('.tableFirstCol').each(function(i){
    if(brow == 'mozilla'){
      $(this).css('height',$('#table_div td:eq('+colCount*n+')').outerHeight());//for providing height using scrollable table column height
    }
    else if(brow == 'msie'){
      $(this).css('height',$('#table_div td:eq('+colCount*n+')').innerHeight()-2);
    }
    else {
      $(this).css('height',$('#table_div td:eq('+colCount*n+')').height());
    }
    n++;
  });
*/
}


function fnScroll(tableName){
  $('#' + tableName + 'Header').scrollLeft($('#' + tableName + 'Table').scrollLeft());
  //$('#' + tableName + 'FirstRow').scrollTop($('#' + tableName + 'Table').scrollTop());
}

function enable_network() {
    $("#group_params").hide();
    $("#login").slideDown(500);
    $("#enable_network").hide();
    $("#exit_group").show();
    
    $("#server_url").removeAttr("disabled");
    $("#user").removeAttr("disabled");
    $("#password").removeAttr("disabled");
    $("#register").removeAttr("disabled");
    
    $("#user").val("");
    $("#password").val("");
    $("#password").show();
    $("#lbl_password").show();
    
        $( "#toggle_connect" )
            .button()
            .click(function() {
                toggle_connect(false);
            })
            .next()
                .button({
                    text: false,
                    icons: {
                        primary: "ui-icon-triangle-1-s"
                    }
                })
                .click(function() {
                    openid_connect_menu(this);
                    return false;
                })
                .parent()
                    .buttonset()
                    .next()
                        .hide()
                        .menu();
    
}

function authentication(state, msg) {
      if(state == WgsState.AUTHENTICATED) {
          $("#server_url").attr("disabled", "disabled");
          $("#user").attr("disabled", "disabled");
          $("#password").attr("disabled", "disabled");
          
          $("#register").attr("disabled", "disabled");
          $("#oic_connect").attr("disabled", "disabled");
          
          $("#toggle_connect").html("Log out");  
          
          $("#user").val(msg.name);
          $("#lbl_password").hide();
          $("#password").hide();

          if(msg.picture) {
            $("#user_picture").attr("src", msg.picture).width(45).height(45);
          } else {
            $("#user_picture").width(0).height(0);
          }

          list_apps();
      } else if(state == WgsState.ERROR) {
          alert(msg);
      }
}


function getAppDescription(app) {
    return app.name; // " (Open:" + app.open + ", Started:" + app.started + ")";
}


function update_apps(response) {
    if(response.apps) { 
        // listApps:
        $('#btn_automatch_group').attr("disabled", "true");
        $('#btn_select_app').attr("disabled", "true");
        $('#btn_delete_app').attr("disabled", "true");
        
        $("#apps option").remove();            
        response.apps.forEach(function(item) {
            $("#apps").append($('<option>').attr('value',item.appId).text(getAppDescription(item)));
        });
        
    } else if(response.cmd == "app_created" || response.cmd == "app_updated") {
        
        if($("#apps option[value='"+response.appId+"']").size() <= 0) {  // insert app
            $("#apps").append($("<option>").attr("value", response.appId));
        }
        $("#apps option[value='"+response.appId+"']").text(getAppDescription(response));
        
    } else if(response.cmd == "app_deleted") {
        
        $("#apps option[value='"+response.appId+"']").remove();
    }
}


function list_apps() {
    $("#apps option").remove();
    wgsclient.listApps(false, function(response) {
        if(response.valid) {
            wgsclient.subscribe("https://github.com/jmarine/wampservices/wgs#apps_event", update_apps, null, { "clientSideOnly":true});
            update_apps(response);
            $("#app_params").hide();
            $("#app_list").slideDown(500);
        }
    });

}

function show_app_params() {
    $("#app_list").hide();
    $("#app_params").slideDown(500);
}

function hide_app_params() {
    $("#app_params").hide();
    $("#app_list").slideDown(500);
}

function show_new_group_params() {
    var app = $("#apps option:selected").text();
    
    var roles = "";
    currentApp.roles.forEach(function(role) {
        roles += '<option value="' + role.name + '">' + role.name + '</option>';
    });    

    $("#new_grp_role option").remove();
    $("#new_grp_role").append(roles);

    $("#new_group_params fieldset legend").html("New group: " + app);
    $("#group_list").hide();
    $("#new_group_params").slideDown(500);
}

function hide_new_group_params() {
    $("#new_group_params").hide();
    $("#group_list").slideDown(500);
}

function getGroupDescription(group) {
    return group.state + " (" + group.num + "/" + group.max + "): " + group.description;
}

function getGroupListItem(group) {
   var opt = $('<tr>');
   opt.attr("gid", group.gid);
   opt.attr('observable', group.observable);   
   opt.attr('class', "scrollTableRow");


   var viewButton = "";
   if(group.observable) viewButton = "<br><button onclick=\"javascript:view_group('" + group.gid + "')\">View</button>";
   
   opt.append('<td>Chess</td>');
   opt.append('<td>' + group.state + (group.password? "<br>(password)" : "" ) + '</td>');
   opt.append('<td>' + group.num + "/" + group.max + viewButton + "</td>");
   
   
   var memberCol = $('<td>');
   var members = $('<table>');

   var count = 0;
   var members = $('<table>');
   group.members.forEach(function(member) {
       count++;
       var row = $("<tr>");
       
       var playerLabel = "Player " + count + (member.role? " ("+ member.role +")" : "");
       row.append("<td>" + playerLabel + ":</td>");
       if(member.name != null && member.name.length > 0) row.append("<td>" + member.name + "</td>");
       else row.append("<td><button onclick=\"javascript:reserve_group_slot('" + group.gid + "'," + member.slot + ")\">Play</button></td>");
        
       members.append(row);
   }); 

   memberCol.append(members);
   opt.append(memberCol);

   return opt;
}

function update_groups(response) {
    $('#btn_play_group').attr("disabled", "true");
    $('#btn_view_group').attr("disabled", "true");
        
    if(response.groups) {
        //$("#groups option").remove();
        $("#groupsTable>table>tbody>tr").remove();
        
        response.groups.forEach(function(item) {
            /*
            var opt = $('<option>')
            opt.attr('value',item.gid).text(getGroupDescription(item));
            opt.attr('observable', item.observable);
            $("#groups").append(opt);
            */
            var opt = getGroupListItem(item);
            $("#groupsTable>table").append(opt);
        });
        
    } else if(response.cmd == "group_deleted") {
        
        //$("#groups option[value='"+response.gid+"']").remove();
        $("#groupsTable>table>tbody>tr[gid='"+response.gid+"']").remove();
        
    } else {  // "group_created" || "group_updated" || user_joined || user_exit || user_updated
        
        if(response.hidden) {
            //$("#groups option[value='"+response.gid+"']").remove();
            $("#groupsTable>table>tbody>tr[gid='"+response.gid+"']").remove();
        } else {
            // if($("#groups option[value='"+response.gid+"']").size() <= 0) {  // insert group
            //   $("#groups").append($("<option>").attr("value", response.gid));
            // }
            //$("#groups option[value='"+response.gid+"']").text(getGroupDescription(response));
            //$("#groups option[value='"+response.gid+"']").attr("observable", response.observable);
            
            if($("#groupsTable>table>tbody>tr[gid='"+response.gid+"']").size() <= 0) {
                $("#groupsTable>table").append(getGroupListItem(response));
            } else {
                $("#groupsTable>table>tbody>tr[gid='"+response.gid+"']").replaceWith(getGroupListItem(response));
            }
        }
        
    } 
    
    $("#group_list").show();
    adjustScrollTable("groups");
}

function app_metaevent(topicURI, metatopic, metaevent) {
    //alert(topicURI + "\n" + metatopic + "\n" + JSON.stringify(metaevent));
}

function hide_group_list() {
    var appId = $("#apps option:selected").attr("value");
    $("#group_list").hide();
    $("#app_list").slideDown(500);
    wgsclient.unsubscribe("https://github.com/jmarine/wampservices/wgs#app_event:" + appId, update_groups, app_metaevent, false);
}

function list_groups() {
    var appId = $("#apps option:selected").attr("value");
    $("#groups option").remove();
    wgsclient.subscribe("https://github.com/jmarine/wampservices/wgs#app_event:" + appId, update_groups, app_metaevent, { "clientSideOnly":true});
    wgsclient.listGroups(appId, function(response) {
        if(response.valid) {
            currentApp = response.app;
            update_groups(response);
            $("#app_list").hide();
            $("#group_list").slideDown(500);
            $("#group_list fieldset legend").html("Groups: " + response.app.name);
        } else {
            wgsclient.unsubscribe("https://github.com/jmarine/wampservices/wgs#app_event:" + appId, update_groups, app_metaevent, false);
        }
    });
}

function delete_app() {
    var appId = $("#apps option:selected").attr("value");
    if(confirm("Do you really want to delete the application?")) {
        wgsclient.deleteApp(appId, function(response) {
            if(!response.valid) {
                alert("Error deleting application:"+response.errorDesc);
            } else {
                $('#btn_automatch_group').attr("disabled", "true");
                $('#btn_select_app').attr("disabled", "true");
                $('#btn_delete_app').attr("disabled", "true");
                update_apps(response);
            }
        });
    }
} 

function create_app() {
    var name = $("#app_name").val();
    var domain = $("#app_domain").val();
    var version = $("#app_version").val();
    var min = $("#app_min").val();
    var max = $("#app_max").val();
    var delta = $("#app_delta").val();
    var observable = $("#app_observable").is(':checked');
    var dynamic = $("#app_dynamic").is(':checked');
    var alliances = $("#app_alliances").is(':checked');
    var ai_available = $("#app_ai_available").is(':checked');
    var roles = [];
    $("#app_roles option").each(function() { roles[roles.length] = $(this).attr("value"); });
    
    wgsclient.newApp(name, domain, version, min, max, delta, observable, dynamic, alliances, ai_available, roles, function(response) {
        if(!response.valid) {
            alert("Error creating application:"+response.errorDesc);
        } else {
            update_apps(response);
            hide_app_params();
        }
    });
}

function add_role() {
    var name = $("#app_role_name").val();
    var required = $("#app_role_required").is(":checked");
    var multiple = $("#app_role_multiple").is(":checked");
    
    var option = new Option(name,name);
    if(multiple) option.value = option.value + (required? "+" : "*");
    else if(!required) option.value = option.value + "?";
    
    $('#app_roles').append(option);
}

function delete_role() {
    $("#app_roles option:selected").remove();
}

function new_group() {
    var gid = $("#new_grp_automatch").is(":checked") ? "automatch" : "";
    var options = new Object();
    options.automatch = $("#new_grp_automatch").is(":checked");
    options.observable = $("#new_grp_observable").is(":checked");
    options.hidden = $("#new_grp_hidden").is(":checked");
    options.password = $("#new_grp_password").val();
    options.role = $("#new_grp_role option:selected").val();
    open_group(gid, options);
}

function view_group(gid) {
    //var gid = $('#groups option:selected').attr('value');
    var options = new Object();
    options.spectator = true;
    open_group(gid, options);
}

function reserve_group_slot(gid,slot) {
    //var gid = $('#groups option:selected').attr('value');
    var options = new Object();
    options.slot = slot;
    open_group(gid, options);
}

function open_group(gid, options) {
    var appId = $("#apps option:selected").attr("value");
    if(gid == "automatch") $("#back_section").val("app_list");
    else $("#back_section").val("group_list");
    
    wgsclient.unsubscribe("https://github.com/jmarine/wampservices/wgs#app_event:" + appId, update_groups, app_metaevent, false);
    wgsclient.openGroup(appId, gid, options, function(response) {
       if(response.valid) {
            //wgsclient.setSubscriptionStatus("https://github.com/jmarine/wampservices/wgs#app_event:" + appId, "busy", null );
            currentApp = response.app;
            if(response.gid != "") wgsclient.subscribe("https://github.com/jmarine/wampservices/wgs#group_event:" + response.gid, update_group_callback, null, { "clientSideOnly":true} );
            show_group(response); 
       } else if(response.errorURI == "https://github.com/jmarine/wampservices/wgs#incorrectpassword") {
            var password = prompt("Introduce the password to access the group:");
            if(password) {
                if(!options) options = {};
                options.password = password;
                open_group(gid, options);
            }
       }
    });
}

function show_group(group) {
    var tbody = $("#group_params table[id='members'] tbody");
    tbody.find("tr").remove();
    
    currentGroup = group;
    $("#group_gid").attr("value", group.gid);
    $("#group_admin").attr("value", group.admin);
    if(group.observable) $("#grp_observable").attr('checked','yes');
    else $("#grp_observable").removeAttr("checked");
    if(group.hidden) $("#grp_hidden").attr('checked','yes');
    else $("#grp_hidden").removeAttr("checked");
    if(group.dynamic) $("#grp_dynamic").attr('checked','yes');
    else $("#grp_dynamic").removeAttr("checked");
    if(group.alliances) $("#grp_alliances").attr('checked','yes');
    else $("#grp_alliances").removeAttr("checked");
    if(group.automatch) $("#grp_automatch").attr('checked','yes');
    else $("#grp_automatch").removeAttr("checked");
    
    $("#group_params fieldset legend").html("Group members: " + group.app.name);
    
    if(group.members) {
        var currentUser = wgsclient.user;
        var currentUserIsOnlineMember = false;
        var currentUserIsOfflineMember = false;
        group.members.forEach(function(member, index) {
            if(!member.connected && member.user==currentUser) {
                currentUserIsOfflineMember = true;
            }
        });
        group.members.forEach(function(member, index) {
            var memberId = index;
            var memberUser = "";
            var selected = "";
            var roleFixed = false;
            var currentUserSelected = false;
            
            if(member.sid==wgsclient.sid) {
                var selected = "";
                if(currentUserIsOfflineMember && (!member.connected) && member.user==currentUser) {
                    currentUserSelected = true;;
                    currentUserIsOnlineMember = true;
                    currentUserIsOfflineMember = false;
                    roleFixed = true;
                }
                if(!currentUserIsOfflineMember && !currentUserIsOnlineMember) {
                    currentUserSelected = true;
                    currentUserIsOnlineMember = true;
                }
            } else {
                memberUser = member.user;
                roleFixed = true;
            }

            append_group_member(false, memberId, member, currentUserSelected, roleFixed, currentApp.ai);

        });
    }

    $("#app_list").hide();
    $("#group_list").hide();
    $("#new_group_params").hide(); 
    $("#toggle_client_state").html("Ready");
    
    if(wgsclient.user == $("#group_admin").val()) {
        $("#start_group").show();
        $("#toggle_client_state").hide();
        $("#add_group_member").show();
        $("#group_options").show();
    }
    else {
        $("#start_group").hide();
        $("#toggle_client_state").show();
        $("#add_group_member").hide();        
        $("#group_options").hide();
    }
    $("#group_params").slideDown(500);
}

function add_group_member(added) {
    var members = $("#group_params table[id='members'] tbody tr");
    append_group_member(added, members.size(), {}, false, false, currentApp.ai);
}

function update_member(field, as_previous_client) 
{
    var appId = $("#apps option:selected").attr("value");
    var gid = $("#group_gid").val();
    var option = $("#" + field + " option:selected");
    var selectedValue = option.val();
    var userTypePos = selectedValue.indexOf(":");
    var sid = selectedValue;
    var usertype = "user";
    if(userTypePos != -1) {
        sid = sid.substring(1+userTypePos);
        usertype = selectedValue.substring(0,userTypePos);
    }
    var user = option.text();
    if(sid == "") user = "";
    else if(sid == wgsclient.sid) user = "";
    var slot = parseInt(field.substring(6));
    var role = $("#role" + slot + " option:selected").val();
    var team = parseInt($("#team" + slot).val());
    wgsclient.updateMember(appId, gid, "RESERVED", slot, sid, usertype, user, role, team, update_group_callback);
    
}

function update_client_state(state)
{
    var appId = $("#apps option:selected").attr("value");
    var gid = $("#group_gid").val();
    wgsclient.updateMember(appId, gid, state, NaN, false, false, false, false, false, update_group_callback);
}

function toggle_client_state()
{
    if($("#toggle_client_state").html().toUpperCase()=="READY") {
        $("#toggle_client_state").html("Busy");
        update_client_state("READY")
    } else {
        $("#toggle_client_state").html("Ready");
        update_client_state("RESERVED");
    }
}


function populate_group_member_fields(added, memberId, member, currentUserSelected, roleFixed, ai) {
    var memberState = member.state ? member.state : "empty";
    var memberUser  = member.user  ? member.user  : "";
    var memberName  = member.name  ? member.name  : "";
    var memberSid   = member.sid   ? member.sid   : "";
    var memberType  = member.type  ? member.type  : "user";
    var memberRole  = member.role  ? member.role  : "";
    
    var userOptions = "";
    if(added || memberUser == "" || memberSid == wgsclient.sid || (wgsclient.user == $("#group_admin").val()) ) {
        userOptions += '<option value="">Empty</option>';
        userOptions += '<option value="user:'+wgsclient.sid+'" ' + ((currentUserSelected && memberType=="user")? "selected" : "") + '>Me</option>';
        if(ai) userOptions += '<option value="computer:'+wgsclient.sid+'" ' + ((currentUserSelected && memberType=="computer")? "selected" : "") + '>MyComputer</option>';
        var connections = wgsclient.getGroupConnections(currentGroup.gid);
        for(var sid in connections) {
            if( (wgsclient.user == $("#group_admin").val()) && (sid != wgsclient.sid) && (memberSid != sid) ) {
                userOptions += '<option value="remote:'+sid+'" ' + ((sid==memberSid)? "selected" : "") + '>'+connections[sid].name+'</option>';
            }
        }
    } 
    
    if(!added && memberUser != "" && memberSid != wgsclient.sid) {
        userOptions += '<option value="remote:'+memberSid+'" selected>' + memberName + '</option>';
    }

    var roleOptions = "";
    currentGroup.app.roles.forEach(function(role) {
        if(!roleFixed || (memberRole==role.name) || memberSid == wgsclient.sid || (wgsclient.user == $("#group_admin").val()) ) {
            roleOptions += '<option value="' + role.name + '" ' + ((memberRole==role.name)? "selected" : "") + '>' + role.name + '</option>';
        }
    });    
    
    
    var memberTeam  = 1;
    if(isFinite(member.team)) {
        memberTeam = member.team;
    } else {
        for(var index = 0; index < memberId; index++) {
            memberTeam = Math.max(memberTeam, 1+parseInt($("#team" + index).val()));
        }
    }
    
    
    $("#member" + memberId+ " option").remove();
    $("#member" + memberId).append(userOptions);
    
    $("#role" + memberId+ " option").remove();
    $("#role" + memberId).append(roleOptions);
    
    $("#team" + memberId).val(memberTeam);
    
    var status = memberState.toLowerCase();
    if(status != 'empty') status = memberType.toLowerCase() + "_" + status;
    $("#state" + memberId).attr("src", "images/" + status + ".png");
    $("#state" + memberId).attr("title", ((status!='empty')? memberType.toUpperCase():"") + " " + memberState);
}

function append_group_member(added, memberId, member, currentUserSelected, roleFixed, ai) {
    var memberRole  = member.role  ? member.role  : "";
    var tbody = $("#group_params table[id='members'] tbody");
    
    var html = '<tr><td align="left"><label for="member' + memberId + '">User ' + (1+memberId) + ':</label><input type="hidden" id="added' + memberId + '" value="' + added + '"/></td>';
    html += '<td align="left"><img title="EMPTY" id="state' + memberId + '" src="images/empty.png" border="0" /></td>';
    html += '<td><select id="member' + memberId + '" onchange="javascript:update_member(\'member'+memberId+'\')">';

    html += '</select></td><td><select id="role' + memberId + '" onchange="javascript:update_member(\'member'+memberId+'\')">';
    currentGroup.app.roles.forEach(function(role) {
        if(!roleFixed || added || (memberRole==role.name)) {
            html += '<option value="' + role.name + '" ' + ((memberRole==role.name)? "selected" : "") + '>' + role.name + '</option>';
        }
    });
    html += '</select></td>';
    html += '<td><input type="number" size="5" id="team' + memberId + '" min="0" max="99999" value="' + (1+memberId) + '" onchange="javascript:update_member(\'member'+memberId+'\')"/></td>';
    if(added) html += '<td><button class="remove_member" onclick="remove_last_member()">X</button></td>';
    html += '</tr>';
    
    $("button.remove_member").hide();
    tbody.append(html);
    
    populate_group_member_fields(added, memberId, member, currentUserSelected, roleFixed, ai);

}

function remove_last_member(memberId) {
    $("#group_params table[id='members'] tbody tr:last").remove();
    $("button.remove_member:last").show();
}

function update_group_callback(response) {
        if(response.valid) {  // TODO: check it is currentGroup gid
            var isMember = isFinite(response.slot);
            var num_members = $("#group_params table[id='members'] tbody tr").size();

            if(response.cmd == "user_joined" || response.cmd == "user_updated" || response.cmd == "group_updated") {

                if(!response.updates) { 
                    // single user_joined
                    if(response.members) response.updates = response.members;
                    else response.updates = [ response ];
                }

                response.updates.forEach(function(member) {
                    var isMember = isFinite(member.slot);

                    if(isMember && member.sid == wgsclient.sid && member.state == "RESERVED") {
                        $("#toggle_client_state").html("Ready");
                    }
                    
                    // create UI fields for new member slots:
                    if(isMember) {
                        var memberId = member.slot;
                        while(num_members <= memberId) {
                            add_group_member(false);
                            num_members += 1;
                        }                        
                    }

                    // append new joined user's user in selectboxes
                    for(var index = 0; index < num_members; index += 1) {
                        if( (wgsclient.user == $("#group_admin").val()) ) {
                            if(member.sid && member.sid != "") {
                                if($("#member"+index+" option[value$=':"+member.sid+"']").size() <= 0) {  // insert user
                                    $("#member"+index).append($("<option>").attr("value", "remote:"+member.sid).text(member.name));
                                }
                            }
                        }
                    }

                    // update UI fields with new member values:
                    if(isMember) {                        
                        var memberId = member.slot;                        
                        $("#team"+memberId).val(member.team);

                        if(wgsclient.user == $("#group_admin").val()) {

                            var val = ((member.sid == wgsclient.sid) ? member.usertype : "remote") + ":" + member.sid;
                            $("#member"+memberId+" option[value='"+val+"']").attr("selected", "selected");
                            $("#role"+memberId+" option[value='"+member.role+"']").attr("selected", "selected");
                            var status = member.state.toLowerCase();
                            if(status != 'empty') status = member.type.toLowerCase() + "_" + status;
                            $("#state" + memberId).attr("src", "images/" + status + ".png");
                            $("#state" + memberId).attr("title", ((status!='empty')? member.type.toUpperCase():"") + " " + member.state);

                        } else {

                            var currentUserSelected = (wgsclient.sid == member.sid);
                            var roleFixed = (member.role != "") && (member.sid != "") && (wgsclient.sid != member.sid);
                            populate_group_member_fields(false, memberId, member, currentUserSelected, roleFixed, currentApp.ai);
                        }
                    }
                });

            } else if(response.cmd == "user_unjoined") {

                // clear unjoined user's user from selectboxes
                for(var index = 0; index < num_members; index += 1) {
                    $("#member"+index+" option[value$=':"+response.sid+"']").remove();
                }
                
                if(response.members) {
                    response.members.forEach(function(member) {
                        var memberId = member.slot;  
                        populate_group_member_fields(false, memberId, member, false, false, currentApp.ai);
                    });
                }
                
            }

            if(response.cmd == "group_updated") {
                if(response.observable) $("#grp_observable").attr('checked','yes');
                else $("#grp_observable").removeAttr("checked");
                if(response.hidden) $("#grp_hidden").attr('checked','yes');
                else $("#grp_hidden").removeAttr("checked");
                if(response.dynamic) $("#grp_dynamic").attr('checked','yes');
                else $("#grp_dynamic").removeAttr("checked");
                if(response.alliances) $("#grp_alliances").attr('checked','yes');
                else $("#grp_alliances").removeAttr("checked");
                if(response.automatch) $("#grp_automatch").attr('checked','yes');
                else $("#grp_automatch").removeAttr("checked");
            
                if(response.state == "STARTED") {
                    for(var index = 0; index < num_members; index += 1) {
                        $("#member"+index+" option[selected!='selected']").remove();
                        $("#role"+index+" option[selected!='selected']").remove();
                        // $("#team"+index).attr("disabled","disabled");
                    }
                }
            }

        } else {
            alert("Error joining user:" + response.errorDesc);
        }    
}

function update_group(state, data) {
    var appId = $("#apps option:selected").attr("value");
    var gid = $("#group_gid").val();
    var automatch = $("#grp_automatch").is(':checked');
    var hidden = $("#grp_hidden").is(':checked');
    var observable = $("#grp_observable").is(':checked');
    var dynamic = $("#grp_dynamic").is(':checked');
    var alliances = $("#grp_alliances").is(':checked');

    wgsclient.updateGroup(appId, gid, state, data, automatch, hidden, observable, dynamic, alliances, function(response) {
        if(response.valid) update_group_callback(response);
    });
}

function start_group() {
    update_group("STARTED", null);
}


function exit_group(toOfflineMode) {
    var gid = $("#group_gid").val();
    if(gid.length > 0) {
        wgsclient.exitGroup(gid, function(response) {
            wgsclient.unsubscribe("https://github.com/jmarine/wampservices/wgs#group_event:" + gid, update_group_callback, null, true);
            //wgsclient.setSubscriptionStatus("https://github.com/jmarine/wampservices/wgs#app_event:" + $("#apps option:selected").attr("value"), null, null );        
            
            if(!toOfflineMode) {
                var back_section = $("#back_section").val();
                $("#group_params").hide();

                // $("#" + back_section).slideDown(500); 
                if(back_section == "group_list") list_groups();
                else list_apps();
            }
            
        });
    }
}

function chat_message(message,sender) {
    if (arguments.length == 1) {
        sender = "";
    }

    var style;

    if (sender == "") {
        style = "client";
    } else if (sender == "server") {
        style = "server";
        sender = "["+sender+"]";
    } else {
        style = "message";
        sender = "["+sender+"]";
    }

    $("#messages").append("<span class='"+style+"'><span class='sender'>"+sender+"</span> <span class='msg'>"+message+"</span></span><br />");
    $("#messages").prop({ scrollTop: $("#messages").prop("scrollHeight")  });
}

function getWebSocket() {
    var url = $("#server_url").val();
    if(!wgsclient || (url != wgsclient.url)) {
        if(wgsclient) {
            try { wgsclient.close(); } 
            catch(e) { }
        }
        wgsclient = new WgsClient(url);
    }
    return wgsclient;
}

function openid_connect(login) {
    
    if(login) {
        var redirectUri = clear_openid_connect_params(true);
        var user = $("#user").val();
        if(user.length == 0) {
            alert("User name is empty");
        } else {
            wgsclient = getWebSocket();
            wgsclient.openIdConnectLoginUrl(user, redirectUri, authentication);
        }
        
    } else {
        var redirectUri = clear_openid_connect_params(false);
        var code = get_url_param("code");
        if(code != null) {
            var url = $("#server_url").val();
            var provider = get_url_param("provider");
            
            wgsclient = new WgsClient(url);
            wgsclient.openIdConnectAuthCode(provider, redirectUri, code, authentication);
        }
    }
}

function get_url_param(param) {
    var value = null;
    var pos = document.location.href.indexOf("&"+param+"=");
    if(pos == -1) pos = document.location.href.indexOf("?"+param+"=");
    if(pos != -1) {
        value = document.location.href.substring(pos+param.length+2);
        pos = value.indexOf("&");
        if(pos != -1) value = value.substring(0, pos);
    }
    return value;
}

function clear_openid_connect_params(clearProvider) {
    // Clear OpenId Connect's parameters
    var url = document.location.href;
    var oicParams = ["code","state","error","error_description"];
    if(clearProvider) oicParams = ["provider", "code","state","error","error_description"];
    oicParams.forEach(function(param) {
        var paramPos = url.indexOf("&"+param+"=");
        if(paramPos == -1) paramPos = url.indexOf("?"+param+"=");
        if(paramPos != -1) {    
            var paramEnd = url.indexOf("&", paramPos+1);
            var otherParams = (paramEnd != -1)? url.substring(paramEnd+1) : "";
            var offset = (otherParams.length==0)? 0 : 1;
            url = url.substring(0, paramPos+offset) + otherParams;
        }
    });

    return url;
}

function disconnect() {
    exit_group(true);
    wgsclient.close();
    wgsclient = null;
    
    $("#server_url").removeAttr("disabled");
    $("#user").removeAttr("disabled");
    $("#password").removeAttr("disabled");
    $("#user_picture").width(0).height(0);    

    $("#register").removeAttr("disabled");
    $("#oic_connect").removeAttr("disabled");
    $("#toggle_connect").html("Log in");
    $("#participants").html("");
    
    $("#enable_network").show();
    $("#exit_group").hide();
    $("#login").hide();
    $("#app_list").hide();    
    $("#app_params").hide();    
    $("#group_list").hide();
    $("#new_group_params").hide();
    $("#group_list").hide(500);
    
    $("#group_params").slideDown(500);  
    
    enable_network();
    document.location.href = clear_openid_connect_params(true);
    
}


function toggle_connect(create_user) {
    if ($("#server_url").attr("disabled") != "disabled") {
        var user = $("#user").val();
        var pass = $("#password").val();
        wgsclient = getWebSocket();
        if(create_user) {
            var email = prompt("Enter e-mail:");
            if(email) wgsclient.register(user, pass, email, authentication);
        } else {
            wgsclient.login(user, pass, authentication);
        }
    } else {
        disconnect();
    }
}

function openid_connect_menu(self) {
    var url = $("#server_url").val();
    var redirectUri = clear_openid_connect_params(true);
    
    wgsclient = getWebSocket();
    wgsclient.openIdConnectProviders(redirectUri, function(response) { 

        var providers = $("#openid_providers_menu");
        providers.find("li:gt(0)").each(function(){
            $(this).remove();
        });

        if(response.valid) {
            response.providers.forEach(function(provider) {
                var link = $("<a>");
                link.text(provider.name);
                link.attr("class", "ui-corner-all")
                if(provider.authEndpoint) link.attr("href", provider.authEndpoint);
                else link.attr("href", "javascript:wgsclient.openIdConnectLoginUrl('"+provider.registrationEndpoint+"', clear_openid_connect_params(true), authentication);");

                var item = $("<li>");
                item.attr("class", "ui-menu-item").append(link)
                providers.append(item);
            });
        }
        
        var menu = $( self ).parent().next().show().position({
                        my: "left top",
                        at: "left bottom",
                        offset: "0 2",
                        of: "#toggle_connect"
                    });
        $( document ).one( "click", function() {
            menu.hide();
            //wgsclient.close();
            //wgsclient = null;
        });

    });
}

</script>

        </head>
<body onload="javascript:enable_network();openid_connect(false)">
<div id="wrapper" style="width: 370px">
  <div id="login" class="section hidden">
    <fieldset>
      <legend>Login</legend>
      
    <table>
    <tr>
        <td><label for="server_url">Service:</label></td><td><input type="text" name="server_url" id="server_url" value="ws://localhost:8080/wgs" /></td>
        <td rowspan="3" valign="top">
            <img id="user_picture" width="0" height="0">
        </td>
    </tr>
    <tr><td><label for="user">User:</label></td><td><input type="text" name="user" id="user" value="guest" /></td></tr>
    <tr><td><label for="password" id="lbl_password">Password:</label></td><td><input type="password" name="password" id="password" value="" /></td></tr>
    </table>
      
    <div class="ui-buttonset">
      <button id="toggle_connect">Log in</button>
      <button id="oic_connect">&nbsp;</button>
      <button id="register" onclick="toggle_connect(true);">Register</button>
    </div>
    
    <ul id="openid_providers_menu" style="display: none">
        <li><a href="javascript:openid_connect(true);">OpenID Connect provider</a></li>
    </ul>    
    
    </fieldset>
  </div>
    
  <div id="app_list" class="section hidden">
    <fieldset>
      <legend>Applications</legend>
    <select id="apps" name="apps" size="8" style="width: 100%">
    </select><br>
    <button id="btn_automatch_group" onclick="open_group('automatch');" disabled >Auto-Match</button>
    <button id="btn_select_app" onclick="list_groups();" disabled >Show groups</button>
    <button id="btn_new_app" onclick="show_app_params();">New</button>
    <button id="btn_delete_app" onclick="delete_app();" disabled >Delete</button>
    </fieldset>
  </div>

  <div id="app_params" class="section hidden">
    <fieldset>
      <legend>Application registration</legend>
    <label for="app_name">Name:</label><input type="text" name="app_name" id="app_name"/><br/>
    <label for="app_domain">Domain:</label><input type="text" name="app_domain" id="app_domain"/><br/>
    <label for="app_version">Version:</label><input type="number" size="5" name="app_version" id="app_version" min="1" max="99999" value="1"/><br/>
    <label for="app_min">Min:</label><input type="number" size="5" name="app_min" id="app_min" min="1" max="99999" value="2"/><br/>
    <label for="app_max">Max:</label><input type="number" size="5" name="app_max" id="app_max" min="0" max="99999" value="2"/><br/>
    <label for="app_delta">Delta:</label><input type="number" size="5" name="app_delta" id="app_delta" min="0" max="99999" value="1"/><br/>
    <label for="app_observable">Observable:</label><input type="checkbox" name="app_observable" id="app_observable" /><br/>
    <label for="app_dynamic">Dynamic:</label><input type="checkbox" name="app_dynamic" id="app_dynamic" /><br/>
    <label for="app_alliances">Alliances:</label><input type="checkbox" name="app_alliances" id="app_alliances" /><br/>
    <label for="app_ai_available">AI engine</label><input type="checkbox" name="app_ai_available" id="app_ai_available" /><br/>

    <label for="app_roles">Roles:</label>
    <table>
    <tr><td>
    <select style="float: left" size="8" name="app_roles" id="app_roles"/><option value="White">White</option><option value="Black">Black</option></select><br/>
    </td>
    <td width="300">
    <label for="app_role_required">Required:</label><input type="checkbox" id="app_role_required" name="app_role_required" checked/></br>
    <label for="app_role_multiple">Multiple</label><input type="checkbox" id="app_role_multiple" name="app_role_multiple" /></br>
    <label for="app_role_name">Name:</label><input type="text" size="10" id="app_role_name" name="app_role_name" value="Green"/><br/>
    <button id="add_role" onclick="add_role();">Add</button><br>
    <button id="delete_role" onclick="delete_role();">Remove</button>
    </td>
    </tr></table>
    <button style="clear: both" id="create_app" onclick="create_app();">Create</button>
    <button style="clear: both" id="hide_app_params" onclick="hide_app_params();">Exit</button>
    </fieldset>
  </div>

  <div id="group_list" class="section hidden">
    <fieldset id="group_list_fieldset">
      <legend>Groups</legend>
    <!--<select id="groups" name="groups" size="8" style="width: 100%"></select>-->
      <div id="groupsHeader" class="scrollTableHeader" style="overflow:hidden;width:100%">
        <table cellspacing="0" cellpadding="0" border="0" >
          <tr id='firstTr'>
            <td>
              <div class="columnHeader">Game</div>
            </td>
            <td>
              <div class="columnHeader">Status</div>
            </td>
            <td>
              <div class="columnHeader">N/T</div>
            </td>
            <td>
              <div class="columnHeader">Members</div>
            </td>
          </tr>
        </table>
      </div>  
      <div id="groupsTable" class="scrollTableData" style="overflow: scroll;width:100%;height:100px;position:relative" onscroll="fnScroll('groups')" >
        <table width="100%" cellspacing="0" cellpadding="0" border="0" >
          <!--<tr>
            <td>Chess</td>
            <td>Open</td>
            <td>2/2</td>
            <td>Judith vs Irene</td>
          </tr>-->
        </table>
      </div>
    <br>
    <!--<button id="btn_play_group" onclick="open_group($('#groups option:selected').attr('value'));" disabled>Play</button>
    <button id="btn_view_group" onclick="view_group();" disabled>View</button>
    -->
    <button id="btn_automatch_group_list" onclick="open_group('automatch');">Auto-Match</button>
    <button id="btn_new_group" onclick="show_new_group_params();">New</button>
    <button id="btn_hide_group" onclick="hide_group_list();">Exit</button>
    </fieldset>
  </div>

  <div id="new_group_params" class="section hidden">
    <fieldset>
      <legend>New group options</legend>
      <label for="new_grp_role">Role:</label><select id="new_grp_role" name="new_grp_role"></select><br/>
      <label for="new_grp_automatch">Auto-match:</label><input type="checkbox" name="new_grp_automatch" id="new_grp_automatch" /><br/>
      <label for="new_grp_observable">Observable</label><input type="checkbox" name="new_grp_observable" id="new_grp_observable" /><br/>
      <label for="new_grp_hidden">Hidden:</label><input type="checkbox" name="new_grp_hidden" id="new_grp_hidden" /><br/>
      <label for="new_grp_password">Password:</label><input type="password" name="new_grp_password" id="new_grp_password" /><br/>
      <button id="new_group" onclick="new_group();">Create</button>
      <button id="hide_group" onclick="hide_new_group_params();">Exit</button>
    </fieldset>
  </div>
    
  <div id="invitations" class="section hidden">
    <fieldset>
      <legend>Invitations</legend>
    <select name="invitations" size="8" style="width: 100%">
    </select><br>
    <button id="accept_invitation" onclick="accept_invitation();">Accept</button>
    <button id="reject_invitation" onclick="reject_invitation();">Reject</button>
    </fieldset>
  </div>

  <div id="group_params" class="section hidden">
    <fieldset>
      <legend>Members</legend>
    <table id="members">
      <thead>
      <tr><th></th><th></th><th>user</th><th>role</th><th>team</th></tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <div id="group_options">
        <label for="grp_automatch">Auto-match:</label><input type="checkbox" name="grp_automatch" id="grp_automatch" onchange="javascript:update_group()"/><br/>
        <label for="grp_hidden">Hidden:</label><input type="checkbox" name="grp_hidden" id="grp_hidden" onchange="javascript:update_group()"/><br/>
        <label for="grp_dynamic">Dynamic:</label><input type="checkbox" name="grp_dynamic" id="grp_dynamic" onchange="javascript:update_group()"/><br/>
        <label for="grp_alliances">Alliances:</label><input type="checkbox" name="grp_alliances" id="grp_alliances" onchange="javascript:update_group()"/><br/>
        <label for="grp_observable">Observable:</label><input type="checkbox" name="grp_observable" id="grp_observable" onchange="javascript:update_group()"/><br/>
        <input type="hidden" id="group_gid" name="group_gid" value="" />
        <input type="hidden" id="group_admin" name="group_admin" value="" />
        <input type="hidden" id="back_section" name="group_list" value="" />
    </div>
    <button id="start_group" onclick="start_group();">Start</button>
    <button id="toggle_client_state" onclick="toggle_client_state();">Ready</button>
    <button id="add_group_member" class="hidden" onclick="add_group_member(true);">Add</button>
    <button id="exit_group" class="hidden" onclick="exit_group();">Exit</button>
    <button id="enable_network" onclick="enable_network();">Enable network</button>
    </fieldset>
  </div>



  <div id="dev_section" class="section">
    <fieldset>
      <legend>Messages</legend>
      <div id="messages"></div>
    </fieldset>
  </div>
</div>
</body>
</html>
