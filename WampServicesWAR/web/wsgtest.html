<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>WebSocket game services client</title>
		<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.19.custom.min.js"></script>
		<script type="text/javascript" src="js/wsgclient.js"></script>
<style type="text/css">

* {
  font-family: Verdana, sans-serif;
  font-size: 12px;
  color: #6c3000;
  background: #f7e3a4; 
}

button, input, select, option {
  background: #fff0c0; 
}

button, input, select {
  border: 1px #6c3000 solid;
  margin-bottom: 2px;
  /* margin-top: 1px; */  
}


button {
  border-radius: 6px;
  margin-top: 5px;
}

button:active {
  background: #dac394;
}

button:disabled, input:disabled {
  background: #f7e3a4;
  color: #777777;
}

option:active {
  background-color: #dac394;
}


fieldset { border: 1px #6c3000 solid; border-radius: 10px; }
legend { border: 1px #6c3000 solid; margin-left: 0.5em; padding: 0.2em 0.8em; border-radius: 10px; font-weight: bold;
          color: #6c3000;
          background:#dac394
}

label { display: block; float: left; width: 90px; clear: left; }

.section { clear: both; width: 100%; padding-bottom: 10px; padding-right: 20px; }
.right { float: left; clear: right; }

.hidden { display: none; }

</style>

<script language="javascript">
var wsgclient = null;
var currentAppAI = null;
var currentGroup = null;

$(document).ready(function(){
    $('#apps').click(function() {
        var c =  $("#apps > option:selected").size();
        $('#btn_automatch_group').each(function() {
          this.disabled = (c==0);
        });
        $('#btn_select_app').each(function() {
          this.disabled = (c==0);
        });
        $('#btn_delete_app').each(function() {
          this.disabled = (c==0);
        });
    });
    
    $('#groups').click(function() {
        var groups = $("#groups > option:selected");
        var c =  groups.size();
        $('#btn_play_group').each(function() {
          this.disabled = (c==0);
        });
        $('#btn_view_group').each(function() {
          this.disabled = (c==0) || (groups[0].attributes['observable'].value != "true");
        });

    });
    
});

function enable_network() {
    $("#group_params").hide();
    $("#login").slideDown(500);
    $("#enable_network").hide();
    $("#exit_group").show();
    
    $("#server_url").removeAttr("disabled");
    $("#user").removeAttr("disabled");
    $("#password").removeAttr("disabled");
    $("#register").removeAttr("disabled");
    
    $("#user").val("");
    $("#password").val("");
    $("#password").show();
    $("#lbl_password").show();
    
}

function authentication(state, msg) {
      if(state == WsgState.AUTHENTICATED) {
          $("#server_url").attr("disabled", "disabled");
          $("#user").attr("disabled", "disabled");
          $("#password").attr("disabled", "disabled");
          $("#register").attr("disabled", "disabled");
          $("#toggle_connect").html("Disconnect");          
          
          $("#user").val(msg.name);
          $("#lbl_password").hide();
          $("#password").hide();
                    
          list_apps();
      } else if(state == WsgState.ERROR) {
          alert(msg);
      }
}


function getAppDescription(app) {
    return app.name; // " (Open:" + app.open + ", Started:" + app.started + ")";
}


function getGroupDescription(group) {
    return group.state + " (" + group.num + "/" + group.max + "): " + group.description;
}

function update_apps(response) {
    if(response.apps) { 
        // listApps:
        $('#btn_automatch_group').attr("disabled", "true");
        $('#btn_select_app').attr("disabled", "true");
        $('#btn_delete_app').attr("disabled", "true");
        
        $("#apps option").remove();            
        response.apps.forEach(function(item) {
            $("#apps").append($('<option>').attr('value',item.appId).text(getAppDescription(item)));
        });
        
    } else if(response.cmd == "app_created" || response.cmd == "app_updated") {
        
        if($("#apps option[value='"+response.appId+"']").size() <= 0) {  // insert app
            $("#apps").append($("<option>").attr("value", response.appId));
        }
        $("#apps option[value='"+response.appId+"']").text(getAppDescription(response));
        
    } else if(response.cmd == "app_deleted") {
        
        $("#apps option[value='"+response.appId+"']").remove();
    }
}


function list_apps() {
    $("#apps option").remove();
    wsgclient.listApps(false, function(response) {
        if(response.valid) {
            wsgclient.subscribe("https://github.com/jmarine/wampservices/wsgservice#apps_event", update_apps, true);
            update_apps(response);
            $("#app_params").hide();
            $("#app_list").slideDown(500);
        }
    });

}

function show_app_params() {
    $("#app_list").hide();
    $("#app_params").slideDown(500);
}

function hide_app_params() {
    $("#app_params").hide();
    $("#app_list").slideDown(500);
}

function show_new_group_params() {
    $("#group_list").hide();
    $("#new_group_params").slideDown(500);
}

function hide_new_group_params() {
    $("#new_group_params").hide();
    $("#group_list").slideDown(500);
}

function update_groups(response) {
    $("#groups option").remove();
    $('#btn_play_group').attr("disabled", "true");
    $('#btn_view_group').attr("disabled", "true");
        
    if(response.groups) {
        response.groups.forEach(function(item) {
            var opt = $('<option>')
            opt.attr('value',item.gid).text(getGroupDescription(item));
            opt.attr('observable', item.observable);
            $("#groups").append(opt);
        });
        
    } else if(response.cmd == "group_created" || response.cmd == "group_updated") {
        
        if(response.hidden) {
            $("#groups option[value='"+response.gid+"']").remove();
        } else {
            if($("#groups option[value='"+response.gid+"']").size() <= 0) {  // insert group
                $("#groups").append($("<option>").attr("value", response.gid));
            }
            $("#groups option[value='"+response.gid+"']").text(getGroupDescription(response));
            $("#groups option[value='"+response.gid+"']").attr("observable", response.observable);
        }
        
    } else if(response.cmd == "group_deleted") {
        
        $("#groups option[value='"+response.gid+"']").remove();
    } 
}

function hide_group_list() {
    var appId = $("#apps option:selected").attr("value");
    $("#group_list").hide();
    $("#app_list").slideDown(500);
    wsgclient.unsubscribe("https://github.com/jmarine/wampservices/wsgservice#app_event:" + appId, update_groups, false);
}

function list_groups() {
    var appId = $("#apps option:selected").attr("value");
    $("#groups option").remove();
    wsgclient.listGroups(appId, function(response) {
        if(response.valid) {
            wsgclient.subscribe("https://github.com/jmarine/wampservices/wsgservice#app_event:" + appId, update_groups, true);
            update_groups(response);
            $("#app_list").hide();
            $("#group_list").slideDown(500);
            $("#group_list fieldset legend").html("Groups: " + response.app.name);
        }
    });
}

function delete_app() {
    var appId = $("#apps option:selected").attr("value");
    if(confirm("Do you really want to delete the application?")) {
        wsgclient.deleteApp(appId, function(response) {
            if(!response.valid) {
                alert("Error deleting application:"+response.errorDesc);
            } else {
                $('#btn_automatch_group').attr("disabled", "true");
                $('#btn_select_app').attr("disabled", "true");
                $('#btn_delete_app').attr("disabled", "true");
                update_apps(response);
            }
        });
    }
} 

function create_app() {
    var name = $("#app_name").val();
    var domain = $("#app_domain").val();
    var version = $("#app_version").val();
    var min = $("#app_min").val();
    var max = $("#app_max").val();
    var delta = $("#app_delta").val();
    var observable = $("#app_observable").is(':checked');
    var dynamic = $("#app_dynamic").is(':checked');
    var alliances = $("#app_alliances").is(':checked');
    var ai_available = $("#app_ai_available").is(':checked');
    var roles = [];
    $("#app_roles option").each(function() { roles[roles.length] = $(this).attr("value"); });
    
    wsgclient.newApp(name, domain, version, min, max, delta, observable, dynamic, alliances, ai_available, roles, function(response) {
        if(!response.valid) {
            alert("Error creating application:"+response.errorDesc);
        } else {
            update_apps(response);
            hide_app_params();
        }
    });
}

function add_role() {
    var name = $("#app_role_name").val();
    var required = $("#app_role_required").is(":checked");
    var multiple = $("#app_role_multiple").is(":checked");
    
    var option = new Option(name,name);
    if(multiple) option.value = option.value + (required? "+" : "*");
    else if(!required) option.value = option.value + "?";
    
    $('#app_roles').append(option);
}

function delete_role() {
    $("#app_roles option:selected").remove();
}

function new_group() {
    var gid = $("#new_grp_automatch").is(":checked") ? "automatch" : "";
    var options = new Object();
    options.automatch = $("#new_grp_automatch").is(":checked");
    options.observable = $("#new_grp_observable").is(":checked");
    options.hidden = $("#new_grp_hidden").is(":checked");
    options.password = $("#new_grp_password").val();
    
    open_group(gid, options);
}

function view_group() {
    var gid = $('#groups option:selected').attr('value');
    var options = new Object();
    options.spectator = true;
    open_group(gid, options);
}

function open_group(gid, options) {
    var appId = $("#apps option:selected").attr("value");
    if(gid == "automatch") $("#back_section").val("app_list");
    else $("#back_section").val("group_list");
    wsgclient.openGroup(appId, gid, options, function(response) {
       if(response.valid) {
            currentAppAI = response.app.ai;
            if(response.gid != "") wsgclient.subscribe("https://github.com/jmarine/wampservices/wsgservice#group_event:" + response.gid, update_group_callback, true);
            show_group(response); 
       } else if(response.errorURI == "https://github.com/jmarine/wampservices/wsgservice#incorrectpassword") {
            var password = prompt("Introduce the password to access the group:");
            if(password) {
                if(!options) options = {};
                options.password = password;
                open_group(gid, options);
            }
       }
    });
}

function show_group(group) {
    var tbody = $("#group_params table[id='members'] tbody");
    tbody.find("tr").remove();
    
    currentGroup = group;
    $("#group_gid").attr("value", group.gid);
    $("#group_admin").attr("value", group.admin);
    if(group.observable) $("#grp_observable").attr('checked','yes');
    else $("#grp_observable").removeAttr("checked");
    if(group.hidden) $("#grp_hidden").attr('checked','yes');
    else $("#grp_hidden").removeAttr("checked");
    if(group.dynamic) $("#grp_dynamic").attr('checked','yes');
    else $("#grp_dynamic").removeAttr("checked");
    if(group.alliances) $("#grp_alliances").attr('checked','yes');
    else $("#grp_alliances").removeAttr("checked");
    if(group.automatch) $("#grp_automatch").attr('checked','yes');
    else $("#grp_automatch").removeAttr("checked");
    
    $("#group_params fieldset legend").html("Group members: " + group.app.name);
    
    if(group.members) {
        var currentUser = wsgclient.user;
        var currentUserIsOnlineMember = false;
        var currentUserIsOfflineMember = false;
        group.members.forEach(function(member, index) {
            if(!member.connected && member.user==currentUser) {
                currentUserIsOfflineMember = true;
            }
        });
        group.members.forEach(function(member, index) {
            var memberId = index;
            var memberUser = "";
            var selected = "";
            var roleFixed = false;
            var currentUserSelected = false;
            
            if(member.sid==wsgclient.sid) {
                var selected = "";
                if(currentUserIsOfflineMember && (!member.connected) && member.user==currentUser) {
                    currentUserSelected = true;;
                    currentUserIsOnlineMember = true;
                    currentUserIsOfflineMember = false;
                    roleFixed = true;
                }
                if(!currentUserIsOfflineMember && !currentUserIsOnlineMember) {
                    currentUserSelected = true;
                    currentUserIsOnlineMember = true;
                }
            } else {
                memberUser = member.user;
                roleFixed = true;
            }

            append_group_member(false, memberId, member, currentUserSelected, roleFixed, currentAppAI);

        });
    }

    $("#app_list").hide();
    $("#group_list").hide();
    $("#new_group_params").hide(); 
    $("#toggle_client_state").html("Ready");
    
    if(wsgclient.user == $("#group_admin").val()) {
        $("#start_group").show();
        $("#toggle_client_state").hide();
        $("#add_group_member").show();
        $("#group_options").show();
    }
    else {
        $("#start_group").hide();
        $("#toggle_client_state").show();
        $("#add_group_member").hide();        
        $("#group_options").hide();
    }
    $("#group_params").slideDown(500);
}

function add_group_member(added) {
    var members = $("#group_params table[id='members'] tbody tr");
    append_group_member(added, members.size(), {}, false, currentAppAI);
}

function update_member(field, as_previous_client) 
{
    var appId = $("#apps option:selected").attr("value");
    var gid = $("#group_gid").val();
    var option = $("#" + field + " option:selected");
    var selectedValue = option.val();
    var userTypePos = selectedValue.indexOf(":");
    var sid = selectedValue;
    var usertype = "user";
    if(userTypePos != -1) {
        sid = sid.substring(1+userTypePos);
        usertype = selectedValue.substring(0,userTypePos);
    }
    var user = option.text();
    if(sid == "") user = "";
    else if(sid == wsgclient.sid) user = "";
    var slot = parseInt(field.substring(6));
    var role = $("#role" + slot + " option:selected").val();
    var team = parseInt($("#team" + slot).val());
    wsgclient.updateMember(appId, gid, "RESERVED", slot, sid, usertype, user, role, team, update_group_callback);
    
}

function update_client_state(state)
{
    var appId = $("#apps option:selected").attr("value");
    var gid = $("#group_gid").val();
    wsgclient.updateMember(appId, gid, state, NaN, false, false, false, false, false, update_group_callback);
}

function toggle_client_state()
{
    if($("#toggle_client_state").html().toUpperCase()=="READY") {
        $("#toggle_client_state").html("Busy");
        update_client_state("READY")
    } else {
        $("#toggle_client_state").html("Ready");
        update_client_state("RESERVED");
    }
}


function populate_group_member_fields(added, memberId, member, currentUserSelected, roleFixed, ai) {
    var memberState = member.state;
    var memberUser = member.user;
    var memberName = member.name;
    var memberSid = member.sid;
    var memberType = member.type;
    var memberRole = member.role;
    var members = "";
    var roles = "";
    if(added || memberUser == "" || memberSid == wsgclient.sid || (wsgclient.user == $("#group_admin").val()) ) {
        members += '<option value="">Empty</option>';
        members += '<option value="user:'+wsgclient.sid+'" ' + ((currentUserSelected && memberType=="user")? "selected" : "") + '>Me</option>';
        if(ai) members += '<option value="computer:'+wsgclient.sid+'" ' + ((currentUserSelected && memberType=="computer")? "selected" : "") + '>MyComputer</option>';
        var connections = wsgclient.getGroupConnections(currentGroup.gid);
        for(var sid in connections) {
            if( (wsgclient.user == $("#group_admin").val()) && (sid != wsgclient.sid) && (memberSid != sid) ) {
                members += '<option value="user:'+sid+'" ' + ((sid==memberSid && memberType=="user")? "selected" : "") + '>user:'+connections[sid].name+'</option>';
            }
        }
    } 
    
    if(!added && memberUser != "" && memberSid != wsgclient.sid) {
        var user = memberUser;
        var val = memberSid;
        if(memberType != "") {
            val = memberType + ":" + val;
            user = memberType + ":" + memberName;
        }
        members += '<option value="'+val+'" selected>' + user + '</option>';
    }
    
    currentGroup.roles.forEach(function(role) {
        if(!roleFixed || (memberRole==role.name) || memberSid == wsgclient.sid || (wsgclient.user == $("#group_admin").val()) ) {
            roles += '<option value="' + role.name + '" ' + ((memberRole==role.name)? "selected" : "") + '>' + role.name + '</option>';
        }
    });    
    
    $("#member" + memberId+ " option").remove();
    $("#member" + memberId).append(members);
    
    $("#role" + memberId+ " option").remove();
    $("#role" + memberId).append(roles);
    
    $("#team" + memberId).val(member.team);
    
    $("#state" + memberId).attr("src", "images/" + memberState.toLowerCase() + ".png");
    $("#state" + memberId).attr("title", memberState);
}

function append_group_member(added, memberId, member, currentUserSelected, roleFixed, ai) {
    var memberState = member.state ? member.state : "empty";
    var memberUser  = member.user  ? member.user  : "";
    var memberName  = member.name  ? member.name  : "";
    var memberSid   = member.sid   ? member.sid   : "";
    var memberType  = member.type  ? member.type  : "user";
    var memberRole  = member.role  ? member.role  : "";
    var tbody = $("#group_params table[id='members'] tbody");
    
    var html = '<tr><td align="left"><label for="member' + memberId + '">User ' + (1+memberId) + ':</label><input type="hidden" id="added' + memberId + '" value="' + added + '"/></td>';
    html += '<td align="left"><img title="EMPTY" id="state' + memberId + '" src="images/empty.png" border="0" /></td>';
    html += '<td><select id="member' + memberId + '" onchange="javascript:update_member(\'member'+memberId+'\')">';

    html += '</select></td><td><select id="role' + memberId + '" onchange="javascript:update_member(\'member'+memberId+'\')">';
    currentGroup.roles.forEach(function(role) {
        if(!roleFixed || added || (memberRole==role.name)) {
            html += '<option value="' + role.name + '" ' + ((memberRole==role.name)? "selected" : "") + '>' + role.name + '</option>';
        }
    });
    html += '</select></td>';
    html += '<td><input type="number" size="5" id="team' + memberId + '" min="0" max="99999" value="' + (1+memberId) + '" onchange="javascript:update_member(\'member'+memberId+'\')"/></td>';
    if(added) html += '<td><button class="remove_member" onclick="remove_last_member()">X</button></td>';
    html += '</tr>';
    
    $("button.remove_member").hide();
    tbody.append(html);
    
    populate_group_member_fields(added, memberId, member, currentUserSelected, roleFixed, ai);

}

function remove_last_member(memberId) {
    $("#group_params table[id='members'] tbody tr:last").remove();
    $("button.remove_member:last").show();
}

function update_group_callback(response) {
        if(response.valid) {  // TODO: check it is currentGroup gid
            var isMember = isFinite(response.slot);
            var num_members = $("#group_params table[id='members'] tbody tr").size();

            if(response.cmd == "user_joined" || response.cmd == "user_updated" || response.cmd == "group_updated") {

                if(!response.updates) { 
                    // single user_joined
                    response.updates = [ response ];
                }

                response.updates.forEach(function(member) {
                    var isMember = isFinite(member.slot);

                    if(isMember && member.sid == wsgclient.sid && member.state == "RESERVED") {
                        $("#toggle_client_state").html("Ready");
                    }
                    
                    // create UI fields for new member slots:
                    if(isMember) {
                        var memberId = member.slot;
                        while(num_members <= memberId) {
                            add_group_member(false);
                            num_members += 1;
                        }                        
                    }

                    // append new joined user's user in selectboxes
                    for(var index = 0; index < num_members; index += 1) {
                        if( (wsgclient.user == $("#group_admin").val()) ) {
                            var val = "";
                            var text = "Empty";
                            if(member.sid && member.sid != "") {
                                val = member.type + ":" + member.sid;
                                text = member.type + ":" + member.name;

                                if($("#member"+index+" option[value='"+val+"']").size() <= 0) {  // insert user
                                    $("#member"+index).append($("<option>").attr("value", val).text(text));
                                }
                            }

                        }
                    }

                    // update UI fields with new member values:
                    if(isMember) {                        
                        var memberId = member.slot;                        
                        $("#team"+memberId).val(member.team);

                        if(wsgclient.user == $("#group_admin").val()) {

                            var val = "";
                            if(member.sid != "") {
                                val = member.type + ":" + member.sid;
                            }
                            $("#member"+memberId+" option[value='"+val+"']").attr("selected", "selected");
                            $("#role"+memberId+" option[value='"+member.role+"']").attr("selected", "selected");
                            $("#state" + memberId).attr("src", "images/" + member.state.toLowerCase() + ".png");
                            $("#state" + memberId).attr("title", member.state);

                        } else {

                            var currentUserSelected = (wsgclient.sid == member.sid);
                            var roleFixed = (member.role != "") && (member.sid != "") && (wsgclient.sid != member.sid);
                            populate_group_member_fields(false, memberId, member, currentUserSelected, roleFixed, currentAppAI);
                        }
                    }
                });

            } else if(response.cmd == "user_unjoined") {

                // clear unjoined user's user from selectboxes
                for(var index = 0; index < num_members; index += 1) {
                    $("#member"+index+" option[value$=':"+response.sid+"']").remove();
                }
                
                if(response.members) {
                    response.members.forEach(function(member) {
                        var memberId = member.slot;  
                        populate_group_member_fields(false, memberId, member, false, false, currentAppAI);
                    });
                }
                
            }

            if(response.cmd == "group_updated") {
                if(response.observable) $("#grp_observable").attr('checked','yes');
                else $("#grp_observable").removeAttr("checked");
                if(response.hidden) $("#grp_hidden").attr('checked','yes');
                else $("#grp_hidden").removeAttr("checked");
                if(response.dynamic) $("#grp_dynamic").attr('checked','yes');
                else $("#grp_dynamic").removeAttr("checked");
                if(response.alliances) $("#grp_alliances").attr('checked','yes');
                else $("#grp_alliances").removeAttr("checked");
                if(response.automatch) $("#grp_automatch").attr('checked','yes');
                else $("#grp_automatch").removeAttr("checked");
            
                if(response.state == "STARTED") {
                    for(var index = 0; index < num_members; index += 1) {
                        $("#member"+index+" option[selected!='selected']").remove();
                        $("#role"+index+" option[selected!='selected']").remove();
                        // $("#team"+index).attr("disabled","disabled");
                    }
                }
            }

        } else {
            alert("Error joining user:" + response.errorDesc);
        }    
}

function update_group(state, data) {
    var appId = $("#apps option:selected").attr("value");
    var gid = $("#group_gid").val();
    var automatch = $("#grp_automatch").is(':checked');
    var hidden = $("#grp_hidden").is(':checked');
    var observable = $("#grp_observable").is(':checked');
    var dynamic = $("#grp_dynamic").is(':checked');
    var alliances = $("#grp_alliances").is(':checked');

    wsgclient.updateGroup(appId, gid, state, data, automatch, hidden, observable, dynamic, alliances, function(response) {
        if(response.valid) update_group_callback(response);
    });
}

function start_group() {
    update_group("STARTED", null);
}


function exit_group(toOfflineMode) {
    if(!toOfflineMode) {
        var back_section = $("#back_section").val();
        $("#group_params").hide();
        $("#" + back_section).slideDown(500);
    }
    
    var gid = $("#group_gid").val();
    wsgclient.exitGroup(gid, function(response) {
        wsgclient.unsubscribe("https://github.com/jmarine/wampservices/wsgservice#group_event:" + gid, update_group_callback, true);
    });
}

function chat_message(message,sender) {
    if (arguments.length == 1) {
        sender = "";
    }

    var style;

    if (sender == "") {
        style = "client";
    } else if (sender == "server") {
        style = "server";
        sender = "["+sender+"]";
    } else {
        style = "message";
        sender = "["+sender+"]";
    }

    $("#messages").append("<span class='"+style+"'><span class='sender'>"+sender+"</span> <span class='msg'>"+message+"</span></span><br />");
    $("#messages").prop({ scrollTop: $("#messages").prop("scrollHeight")  });
}

function my_openid_connect(login) {
    if(login) {
        var oicAuthEndpointUrl = "http://localhost:3000/authorizations/new";
        var clientId = "baa143594505f996a5467e4ae00af220";
        var queryPos = document.location.href.indexOf("?");
        if(queryPos == -1) queryPos = document.location.href.length;
        document.location.href = oicAuthEndpointUrl + "?response_type=code&scope=openid%20profile%20email&client_id=" + clientId + "&redirect_uri=" + document.location.href.substring(0,queryPos);
    } else {
        var codePos = document.location.href.indexOf("&code=");
        if(codePos == -1) codePos = document.location.href.indexOf("?code=");
        if(codePos != -1) {
            var code = document.location.href.substring(codePos+6);
            codePos = code.indexOf("&");
            if(codePos != -1) code = code.substring(0, codePos);
            
            var url = $("#server_url").val();
            var oicProvider = "defaultProvider";
            
            wsgclient = new WsgClient(url);
            wsgclient.openIdConnect(oicProvider, code, authentication);
        }
    }
}

function clear_openid_connect_params() {
    // Clear OpenId Connect's authentication code 
    var url = document.location.href;
    var codePos = url.indexOf("&code=");
    if(codePos == -1) codePos = url.indexOf("?code=");
    if(codePos != -1) {
        var codeEnd = url.indexOf("&", codePos+1);
        var otherParams = (codeEnd != -1)? url.substring(codeEnd+1) : "";
        var offset = (otherParams.length==0)? 0 : 1;
        url = url.substring(0, codePos+offset) + otherParams;
        
        // Clear OpenId Connect's authentication state
        var statePos = url.indexOf("&state=")
        if(statePos == -1) statePos = url.indexOf("?state=");
        if(statePos != -1) {
            var stateEnd = url.indexOf("&", statePos+1);
            otherParams = (stateEnd != -1)? url.substring(stateEnd+1) : "";
            offset = (otherParams.length==0)? 0 : 1;
            url = url.substring(0, statePos+offset) + otherParams;
        }
        
        document.location.href = url;
    }
}

function disconnect() {
    exit_group(true);
    wsgclient.close();
    $("#server_url").removeAttr("disabled");
    $("#user").removeAttr("disabled");
    $("#password").removeAttr("disabled");
    $("#register").removeAttr("disabled");
    $("#toggle_connect").html("Connect");
    $("#participants").html("");
    
    $("#enable_network").show();
    $("#exit_group").hide();
    $("#login").hide();
    $("#app_list").hide();    
    $("#app_params").hide();    
    $("#group_list").hide();
    $("#new_group_params").hide();
    $("#group_list").hide(500);
    
    $("#group_params").slideDown(500);  
    
    enable_network();
    clear_openid_connect_params();
    
}


function toggle_connect(create_user) {
    if ($("#server_url").attr("disabled") != "disabled") {
        var url = $("#server_url").val();
        var user = $("#user").val();
        var pass = $("#password").val();

        wsgclient = new WsgClient(url);
        if(create_user) {
            var email = prompt("Enter e-mail:");
            if(email) wsgclient.register(user, pass, email, authentication);
        } else {
            wsgclient.login(user, pass, authentication);
        }
    } else {
        disconnect();
    }
}


</script>

        </head>
<body onload="javascript:enable_network();my_openid_connect(false)">
<div id="wrapper" style="width: 370px">
  <div id="login" class="section hidden">
    <fieldset>
      <legend>Login</legend>
    <label for="server_url">Server:</label><input type="text" name="server_url" id="server_url" value="ws://localhost:8080/wsgservice" /><br/>
    <label for="user">Login:</label><input type="text" name="user" id="user" value="guest" /><br/>
    <label for="password" id="lbl_password">Password:</label><input type="password" name="password" id="password" value="guest" /><br/>
    <button id="oic_connect" onclick="my_openid_connect(true);">OpenId Connect</button>
    <button id="toggle_connect" onclick="toggle_connect(false);">Connect</button>
    <button id="register" onclick="toggle_connect(true);">Register</button>
    </fieldset>
  </div>
    
  <div id="app_list" class="section hidden">
    <fieldset>
      <legend>Application</legend>
    <select id="apps" name="apps" size="8" style="width: 100%">
    </select><br>
    <button id="btn_automatch_group" onclick="open_group('automatch');" disabled >Auto-Match</button>
    <button id="btn_select_app" onclick="list_groups();" disabled >Show groups</button>
    <button id="btn_new_app" onclick="show_app_params();">New</button>
    <button id="btn_delete_app" onclick="delete_app();" disabled >Delete</button>
    </fieldset>
  </div>

  <div id="app_params" class="section hidden">
    <fieldset>
      <legend>Application registration</legend>
    <label for="app_name">Name:</label><input type="text" name="app_name" id="app_name"/><br/>
    <label for="app_domain">Domain:</label><input type="text" name="app_domain" id="app_domain"/><br/>
    <label for="app_version">Version:</label><input type="number" size="5" name="app_version" id="app_version" min="1" max="99999" value="1"/><br/>
    <label for="app_min">Min:</label><input type="number" size="5" name="app_min" id="app_min" min="1" max="99999" value="2"/><br/>
    <label for="app_max">Max:</label><input type="number" size="5" name="app_max" id="app_max" min="0" max="99999" value="2"/><br/>
    <label for="app_delta">Delta:</label><input type="number" size="5" name="app_delta" id="app_delta" min="0" max="99999" value="1"/><br/>
    <label for="app_observable">Observable:</label><input type="checkbox" name="app_observable" id="app_observable" /><br/>
    <label for="app_dynamic">Dynamic:</label><input type="checkbox" name="app_dynamic" id="app_dynamic" /><br/>
    <label for="app_alliances">Alliances:</label><input type="checkbox" name="app_alliances" id="app_alliances" /><br/>
    <label for="app_ai_available">AI engine</label><input type="checkbox" name="app_ai_available" id="app_ai_available" /><br/>

    <label for="app_roles">Roles:</label>
    <table>
    <tr><td>
    <select style="float: left" size="8" name="app_roles" id="app_roles"/><option value="White">White</option><option value="Black">Black</option></select><br/>
    </td>
    <td width="300">
    <label for="app_role_required">Required:</label><input type="checkbox" id="app_role_required" name="app_role_required" checked/></br>
    <label for="app_role_multiple">Multiple</label><input type="checkbox" id="app_role_multiple" name="app_role_multiple" /></br>
    <label for="app_role_name">Name:</label><input type="text" size="10" id="app_role_name" name="app_role_name" value="Green"/><br/>
    <button id="add_role" onclick="add_role();">Add</button><br>
    <button id="delete_role" onclick="delete_role();">Remove</button>
    </td>
    </tr></table>
    <button style="clear: both" id="create_app" onclick="create_app();">Create</button>
    <button style="clear: both" id="hide_app_params" onclick="hide_app_params();">Exit</button>
    </fieldset>
  </div>

  <div id="group_list" class="section hidden">
    <fieldset id="group_list_fieldset">
      <legend>Groups</legend>
    <select id="groups" name="groups" size="8" style="width: 100%">
    </select><br>
    <button id="btn_play_group" onclick="open_group($('#groups option:selected').attr('value'));" disabled>Play</button>
    <button id="btn_view_group" onclick="view_group();" disabled>View</button>
    <button id="btn_new_group" onclick="show_new_group_params();">New</button>
    <button id="btn_hide_group" onclick="hide_group_list();">Exit</button>
    </fieldset>
  </div>

  <div id="new_group_params" class="section hidden">
    <fieldset>
      <legend>New group options</legend>
      <label for="new_grp_automatch">Auto-match:</label><input type="checkbox" name="new_grp_automatch" id="new_grp_automatch" /><br/>
      <label for="new_grp_observable">Observable</label><input type="checkbox" name="new_grp_observable" id="new_grp_observable" /><br/>
      <label for="new_grp_hidden">Hidden:</label><input type="checkbox" name="new_grp_hidden" id="new_grp_hidden" /><br/>
      <label for="new_grp_password">Password:</label><input type="password" name="new_grp_password" id="new_grp_password" /><br/>
      <button id="new_group" onclick="new_group();">Create</button>
      <button id="hide_group" onclick="hide_new_group_params();">Exit</button>
    </fieldset>
  </div>
    
  <div id="invitations" class="section hidden">
    <fieldset>
      <legend>Invitations</legend>
    <select name="invitations" size="8" style="width: 100%">
    </select><br>
    <button id="accept_invitation" onclick="accept_invitation();">Accept</button>
    <button id="reject_invitation" onclick="reject_invitation();">Reject</button>
    </fieldset>
  </div>

  <div id="group_params" class="section hidden">
    <fieldset>
      <legend>Members</legend>
    <table id="members">
      <thead>
      <tr><th></th><th></th><th>user</th><th>role</th><th>team</th></tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <div id="group_options">
        <label for="grp_automatch">Auto-match:</label><input type="checkbox" name="grp_automatch" id="grp_automatch" onchange="javascript:update_group()"/><br/>
        <label for="grp_hidden">Hidden:</label><input type="checkbox" name="grp_hidden" id="grp_hidden" onchange="javascript:update_group()"/><br/>
        <label for="grp_dynamic">Dynamic:</label><input type="checkbox" name="grp_dynamic" id="grp_dynamic" onchange="javascript:update_group()"/><br/>
        <label for="grp_alliances">Alliances:</label><input type="checkbox" name="grp_alliances" id="grp_alliances" onchange="javascript:update_group()"/><br/>
        <label for="grp_observable">Observable:</label><input type="checkbox" name="grp_observable" id="grp_observable" onchange="javascript:update_group()"/><br/>
        <input type="hidden" id="group_gid" name="group_gid" value="" />
        <input type="hidden" id="group_admin" name="group_admin" value="" />
        <input type="hidden" id="back_section" name="group_list" value="" />
    </div>
    <button id="start_group" onclick="start_group();">Start</button>
    <button id="toggle_client_state" onclick="toggle_client_state();">Ready</button>
    <button id="add_group_member" class="hidden" onclick="add_group_member(true);">Add</button>
    <button id="exit_group" class="hidden" onclick="exit_group();">Exit</button>
    <button id="enable_network" onclick="enable_network();">Enable network</button>
    </fieldset>
  </div>



  <div id="dev_section" class="section">
    <fieldset>
      <legend>Messages</legend>
      <div id="messages"></div>
    </fieldset>
  </div>
</div>
</body>
</html>
